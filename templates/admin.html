<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | CertiChain</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-olive: #556b2f; /* Olive Green */
            --light-olive: #f4f7f1;
            --pure-white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --danger: #e74c3c;
            --bg-gray: #f9fbf7;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        body {
            background-color: var(--bg-gray);
            color: var(--text-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Top Header */
        header {
            background: var(--pure-white);
            padding: 12px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 10;
            border-bottom: 3px solid var(--primary-olive);
        }

        .logo { font-size: 22px; font-weight: 800; color: var(--primary-olive); display: flex; align-items: center; gap: 10px; }

        .logout-btn {
            background-color: var(--primary-olive);
            color: var(--pure-white);
            padding: 8px 20px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: 0.3s;
        }
        .logout-btn:hover { background-color: #3e4e22; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        /* Analytics Bar */
        .analytics-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            padding: 20px 40px;
        }

        .stat-card {
            background: var(--pure-white);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
        }

        .stat-icon {
            width: 55px; height: 55px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
        }

        .stat-info p { margin: 0; font-size: 12px; color: var(--text-light); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .stat-info h3 { margin: 5px 0 0; font-size: 32px; color: var(--text-dark); }

        /* Dashboard Body */
        .dashboard-container {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 25px;
            padding: 0 40px 25px;
            flex-grow: 1;
            overflow: hidden;
        }

        .panel {
            background: var(--pure-white);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            border: 1px solid #eee;
            overflow: hidden;
        }

        .panel-header {
            padding: 18px 25px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fdfdfd;
        }

        .panel-header i { color: var(--primary-olive); font-size: 18px; }
        .panel-header h2 { margin: 0; font-size: 15px; font-weight: 700; color: var(--text-dark); text-transform: uppercase; }

        .content-scroll { padding: 25px; overflow-y: auto; flex-grow: 1; }

        /* Form Styling */
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 12px; font-weight: 700; color: var(--text-light); }
        
        .input-box { position: relative; }
        .input-box i.prefix { position: absolute; left: 14px; top: 13px; color: var(--primary-olive); font-size: 14px; }
        
        input, select {
            width: 100%;
            padding: 11px 15px 11px 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: 0.3s;
            box-sizing: border-box;
            background: #fff;
        }

        input:focus, select:focus { border-color: var(--primary-olive); outline: none; box-shadow: 0 0 0 3px rgba(85, 107, 47, 0.1); }

        .eye-icon { position: absolute; right: 14px; top: 13px; cursor: pointer; color: #999; }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: #fafafa;
        }
        .upload-zone:hover { border-color: var(--primary-olive); background: var(--light-olive); }

        .btn-issue {
            width: 100%;
            padding: 14px;
            background: var(--primary-olive);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            gap: 10px;
            transition: 0.3s;
            margin-top: 15px;
            text-transform: uppercase;
            font-size: 13px;
        }
        .btn-issue:hover { background: #3e4e22; transform: translateY(-1px); }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #fcfcfc; color: var(--text-light); font-size: 11px; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
        
        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .bg-success { background: #eef7e8; color: #5a7d26; border: 1px solid #d4e8c4; }
        .bg-danger { background: #fdeaea; color: #c0392b; border: 1px solid #f5c6cb; }

        /* Scrollbar styling */
        .content-scroll::-webkit-scrollbar { width: 6px; }
        .content-scroll::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fas fa-shield-halved"></i> SmartCert <span style="font-weight: 300;">Admin</span></div>
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout Access</a>
    </header>

    <div class="analytics-bar">
        <div class="stat-card">
            <div class="stat-icon" style="background: #eef7e8; color: var(--primary-olive);"><i class="fas fa-file-circle-check"></i></div>
            <div class="stat-info"><p>Total Issued</p><h3 id="count-issued">0</h3></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #e1f0f7; color: #2980b9;"><i class="fas fa-fingerprint"></i></div>
            <div class="stat-info"><p>Verifications</p><h3 id="count-verified">0</h3></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fdeaea; color: var(--danger);"><i class="fas fa-shield-virus"></i></div>
            <div class="stat-info"><p>Security Alerts</p><h3 id="count-alerts">0</h3></div>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="panel">
            <div class="panel-header"><i class="fas fa-pen-to-square"></i><h2>Issue New Certificate</h2></div>
            <div class="content-scroll">
                <form id="issue-form">
                    <div class="form-group">
                        <label>Admin Security Key</label>
                        <div class="input-box">
                            <i class="fas fa-lock prefix"></i>
                            <input type="password" id="admin_pass" placeholder="System access key" required>
                            <i class="fas fa-eye eye-icon" onclick="togglePass()"></i>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Student Full Name</label>
                        <div class="input-box">
                            <i class="fas fa-user-graduate prefix"></i>
                            <input type="text" name="name" placeholder="As per official records" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Enrollment / Student ID</label>
                        <div class="input-box">
                            <i class="fas fa-hashtag prefix"></i>
                            <input type="text" name="id" placeholder="Unique ID number" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <div class="input-box">
                            <i class="fas fa-at prefix"></i>
                            <input type="email" name="email" placeholder="student@university.edu" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Academic Department</label>
                        <div class="input-box">
                            <i class="fas fa-building-columns prefix"></i>
                            <select name="dept" required>
                                <option value="" disabled selected>Select Department</option>
                                <optgroup label="Undergraduate (UG)">
                                    <option value="B.Sc. Computer Science">B.Sc. Computer Science</option>
                                    <option value="B.Sc. Information Technology">B.Sc. Information Technology</option>
                                    <option value="B.Sc. Physics">B.Sc. Physics</option>
                                    <option value="B.Sc. Chemistry">B.Sc. Chemistry</option>
                                    <option value="B.Sc. Mathematics">B.Sc. Mathematics</option>
                                </optgroup>
                                <optgroup label="Postgraduate (PG)">
                                    <option value="M.Sc. Computer Science">M.Sc. Computer Science</option>
                                    <option value="MCA">MCA</option>
                                    <option value="MBA">MBA</option>
                                </optgroup>
                                <optgroup label="Arts & Commerce">
                                    <option value="B.A. English">B.A. English</option>
                                    <option value="B.Com">B.Com</option>
                                    <option value="BBA">BBA</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Passing Year</label>
                        <div class="input-box">
                            <i class="fas fa-calendar-check prefix"></i>
                            <input type="number" name="year" value="2024" required>
                        </div>
                    </div>

                    <div class="upload-zone" onclick="document.getElementById('file-input').click()">
                        <div id="up-ui">
                            <i class="fas fa-file-arrow-up" style="font-size: 20px; color: var(--primary-olive); margin-bottom: 8px;"></i>
                            <p style="margin:0; font-size: 12px; color: var(--text-light);">Drop certificate image here</p>
                        </div>
                        <div id="file-info" style="display:none; font-weight:700; color:var(--primary-olive); font-size: 13px;">
                            <span id="fn"></span> <i class="fas fa-circle-xmark trash-icon" style="color:var(--danger); cursor:pointer; margin-left:10px;" onclick="resetFile(event)"></i>
                        </div>
                        <input type="file" id="file-input" name="image" style="display:none;" onchange="handleFile()" required>
                    </div>

                    <button type="button" class="btn-issue" onclick="checkAndIssue()">
                        <i class="fas fa-cube"></i> Sign & Issue on Blockchain
                    </button>
                </form>
                <div id="status-msg" style="margin-top:15px; text-align:center; font-size:13px;"></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><i class="fas fa-list-ul"></i><h2>Live Verification Logs</h2></div>
            <div class="content-scroll">
                <table>
                    <thead>
                        <tr><th>Student ID</th><th>Timestamp</th><th>Integrity Status</th></tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function togglePass() {
            const p = document.getElementById('admin_pass');
            p.type = p.type === 'password' ? 'text' : 'password';
        }

        function handleFile() {
            const f = document.getElementById('file-input').files[0];
            if(f) {
                document.getElementById('up-ui').style.display = 'none';
                document.getElementById('file-info').style.display = 'block';
                document.getElementById('fn').innerText = f.name;
            }
        }

        function resetFile(e) {
            e.stopPropagation();
            document.getElementById('file-input').value = '';
            document.getElementById('up-ui').style.display = 'block';
            document.getElementById('file-info').style.display = 'none';
        }

        async function checkAndIssue() {
            const form = document.getElementById('issue-form');
            const msg = document.getElementById('status-msg');
            if (!form.checkValidity()) { form.reportValidity(); return; }

            msg.innerHTML = "⏳ Initializing Blockchain Signature...";
            msg.style.color = "var(--primary-olive)";

            const fd = new FormData(form);
            fd.append('admin_pass', document.getElementById('admin_pass').value);

            try {
                let r = await fetch('/issue', { method: 'POST', body: fd });
                let res = await r.json();

                if (res.status === "Success") {
                    msg.innerHTML = `
                        <div style="background: #eef7e8; padding: 12px; border-radius: 8px; border: 1px solid #d4e8c4;">
                            <p style="color: #5a7d26; font-weight: bold; margin: 0 0 10px 0;">✅ Protocol Executed Successfully!</p>
                            <a href="${res.pdf_url}" target="_blank" style="background: var(--primary-olive); color: white; padding: 8px 12px; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block;">
                                <i class="fas fa-download"></i> GET PDF
                            </a>
                        </div>
                    `;
                    form.reset();
                    resetFile({stopPropagation: () => {}}); 
                } else {
                    msg.innerHTML = "❌ Authentication Failed: " + res.message;
                    msg.style.color = "var(--danger)";
                }
            } catch (e) {
                msg.innerHTML = "❌ System Offline! Check Flask Server.";
                msg.style.color = "var(--danger)";
            }
        }

        async function sync() {
            try {
                let r1 = await fetch('/get_analytics'); let d1 = await r1.json();
                document.getElementById('count-issued').innerText = d1.issued;
                document.getElementById('count-verified').innerText = d1.verified;
                document.getElementById('count-alerts').innerText = d1.alerts;

                let r2 = await fetch('/get_history'); let d2 = await r2.json();
                let html = '';
                d2.slice().reverse().forEach(row => {
                    let badge = row.status.includes("Genuine") ? "bg-success" : "bg-danger";
                    html += `<tr>
                        <td style="font-weight:700;">${row.id}</td>
                        <td style="color:var(--text-light); font-size: 12px;">${row.time}</td>
                        <td><span class="status-badge ${badge}">${row.status}</span></td>
                    </tr>`;
                });
                document.getElementById('history-body').innerHTML = html || '<tr><td colspan="3" style="text-align:center; color:#ccc; padding:30px;">Waiting for logs...</td></tr>';
            } catch(e){}
        }
        setInterval(sync, 4000); sync();
    </script>
</body>
</html>

